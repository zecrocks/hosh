services:
  web:
    build:
      context: .
      dockerfile: dev.Dockerfile
    image: hosh/dev
    command:
      [
        "cargo",
        "watch",
        "-q",
        "-c",
        "-w",
        "crates",
        "-x",
        "run -p hosh -- --roles web",
      ]
    ports:
      - "8080:8080"
    volumes:
      - .:/app
      - target-cache:/app/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - API_KEY=${API_KEY}
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - RESULTS_WINDOW_DAYS=${RESULTS_WINDOW_DAYS:-30}
    depends_on:
      chronicler:
        condition: service_healthy

  discovery:
    image: hosh/dev
    command:
      [
        "cargo",
        "watch",
        "-q",
        "-c",
        "-w",
        "crates",
        "-x",
        "run -p hosh -- --roles discovery",
      ]
    volumes:
      - .:/app
      - target-cache:/app/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - DISCOVERY_INTERVAL=3600
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      web:
        condition: service_started
      chronicler:
        condition: service_healthy

  checker-zec:
    image: hosh/dev
    command:
      [
        "cargo",
        "watch",
        "-q",
        "-c",
        "-w",
        "crates",
        "-x",
        "run -p hosh -- --roles checker-zec",
      ]
    volumes:
      - .:/app
      - target-cache:/app/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - SOCKS_PROXY=tor:9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      web:
        condition: service_started
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  checker-zec-1:
    image: hosh/dev
    command:
      [
        "cargo",
        "watch",
        "-q",
        "-c",
        "-w",
        "crates",
        "-x",
        "run -p hosh -- --roles checker-zec",
      ]
    volumes:
      - .:/app
      - target-cache:/app/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - SOCKS_PROXY=tor:9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      web:
        condition: service_started
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  checker-btc:
    image: hosh/dev
    command:
      [
        "cargo",
        "watch",
        "-q",
        "-c",
        "-w",
        "crates",
        "-x",
        "run -p hosh -- --roles checker-btc",
      ]
    volumes:
      - .:/app
      - target-cache:/app/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - RUN_MODE=worker
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - TOR_PROXY_HOST=tor
      - TOR_PROXY_PORT=9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      web:
        condition: service_started
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  dashboard:
    build: contrib/dashboard
    image: hosh/dashboard
    container_name: data-dashboard
    ports:
      - "8050:8050"
    profiles:
      - dev
    volumes:
      - ./contrib/dashboard:/app
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      chronicler:
        condition: service_healthy

  docs:
    image: peaceiris/mdbook:latest
    profiles:
      - dev
    ports:
      - "3000:3000"
      - "3001:3001"
    volumes:
      - .:/hosh
    command: ["serve", "--hostname", "0.0.0.0", "--port", "3000"]
    working_dir: /hosh/docs

  architecture:
    image: terrastruct/d2:v0.1.2
    profiles:
      - disabled
      - dev
    environment:
      - D2_LAYOUT=dagre
    volumes:
      - ./docs/src:/home/debian/src
    ports:
      - "8000:8080"
    command: ["--watch", "/home/debian/src/architecture.d2"]

  redis:
    image: redis:alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: always
    profiles:
      - dev

  nostr-alert:
    build:
      context: ./contrib/nostr-alert
      dockerfile: dev.Dockerfile
    image: hosh/nostr-alert-dev
    volumes:
      - ./contrib/nostr-alert:/usr/src/nostr-alert
      - ./contrib/nostr-alert/target:/usr/src/nostr-alert/target
      - cargo-cache:/usr/local/cargo/registry
    environment:
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - ADMIN_PUB_KEY=${ADMIN_PUB_KEY}
      - HOSH_PRIV_KEY=${HOSH_PRIV_KEY}
      - ZEC_HTML_URL=${ZEC_HTML_URL:-http://web:8080/zec}
      - BTC_HTML_URL=${BTC_HTML_URL:-http://web:8080/btc}
      - ZEC_API_URL=${ZEC_API_URL:-http://web:8080/api/v0/zec.json}
      - BTC_API_URL=${BTC_API_URL:-http://web:8080/api/v0/btc.json}
      - CHECK_INTERVAL_SECONDS=${CHECK_INTERVAL_SECONDS:-300}
      - MAX_CHECK_AGE_MINUTES=${MAX_CHECK_AGE_MINUTES:-30}
      - GENERATE_KEYS=${GENERATE_KEYS:-false}
    command: ["cargo", "watch", "-q", "-c", "-w", "src", "-x", "run"]
    profiles:
      - dev

volumes:
  cargo-cache:
  target-cache:
  redis-data:
