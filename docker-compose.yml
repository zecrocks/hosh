services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: hosh/hosh
    container_name: web
    command: ["--roles", "web"]
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - API_KEY=${API_KEY}
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - RESULTS_WINDOW_DAYS=${RESULTS_WINDOW_DAYS:-30}
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    depends_on:
      chronicler:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/8080'",
        ]
      interval: 5s
      timeout: 3s
      retries: 5

  checker-btc:
    image: hosh/hosh
    command: ["--roles", "checker-btc"]
    environment:
      - RUST_LOG=warning
      - RUN_MODE=worker
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - TOR_PROXY_HOST=tor
      - TOR_PROXY_PORT=9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    depends_on:
      web:
        condition: service_healthy
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  checker-zec:
    image: hosh/hosh
    command: ["--roles", "checker-zec"]
    environment:
      - RUST_LOG=warning
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - SOCKS_PROXY=tor:9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    depends_on:
      web:
        condition: service_healthy
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  checker-zec-1:
    image: hosh/hosh
    command: ["--roles", "checker-zec"]
    environment:
      - RUST_LOG=warning
      - WEB_API_URL=http://web:8080
      - API_KEY=${API_KEY}
      - SOCKS_PROXY=tor:9050
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    depends_on:
      web:
        condition: service_healthy
      tor:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  discovery:
    image: hosh/hosh
    container_name: discovery
    command: ["--roles", "discovery"]
    environment:
      - RUST_LOG=${RUST_LOG:-warning}
      - DISCOVERY_INTERVAL=3600
      - CLICKHOUSE_HOST=chronicler
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    depends_on:
      web:
        condition: service_healthy
      chronicler:
        condition: service_healthy

  tor:
    image: osminogin/tor-simple
    container_name: tor
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl --fail --socks5-hostname localhost:9050 -s https://check.torproject.org/ | grep -qm1 Congratulations",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    environment:
      - TOR_NewCircuitPeriod=300
      - TOR_MaxCircuitDirtiness=600
    ports:
      - "9050:9050"
    restart: on-failure:5
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 120s

  chronicler:
    build: ./chronicler
    container_name: chronicler
    environment:
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DB=${CLICKHOUSE_DB}
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "5"
    ports:
      - "8123:8123" # HTTP interface
      - "9000:9000" # Native interface
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1:8123/ping",
        ]
      interval: 5s
      timeout: 3s
      retries: 5
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

volumes:
  clickhouse-data:
